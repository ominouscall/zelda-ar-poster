<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Twilight Memory</title>

<style>
    @font-face {
        font-family: "WiiRegular";
        src: url("TPHylian-WiiRegular.otf");
    }
    @font-face {
        font-family: "GCNBold";
        src: url("TPHylian-GCNBold.otf");
    }

    body {
        margin: 0;
        overflow: hidden;
        background: black;
        font-family: "WiiRegular", serif;
    }

    #bgVideo {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        z-index: 1;
        transition: filter 1s ease;
    }

    .morningFilter {
        filter: brightness(1.15) saturate(1.1) sepia(0.08) hue-rotate(-5deg) contrast(1.03);
    }
    .afternoonFilter {
        filter: brightness(1.05) saturate(1.15) hue-rotate(8deg) contrast(1.05) saturate(1.08);
    }
    .nightFilter {
        filter: brightness(0.65) saturate(0.85) hue-rotate(-25deg) contrast(0.92) brightness(0.85);
    }

    #secretVideo {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        object-fit: fill;
        z-index: 9999;
        display: none;
        background: black;
    }
    
    #overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 2;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        backdrop-filter: blur(2px);
    }

    #quote {
        font-family: "WiiRegular";
        color: #e8d8a8;
        font-size: 1.3rem;
        max-width: 90vw;
        text-align: center;
        margin-bottom: 40px;
        text-shadow: 2px 2px 4px black;
    }

    #startButton {
        font-family: "GCNBold";
        font-size: 2rem;
        color: #e8d8a8;
        border: 2px solid #e8d8a8;
        padding: 12px 28px;
        border-radius: 4px;
        cursor: pointer;
        background: rgba(0,0,0,0.6);
        text-shadow: 2px 2px 4px black;
        transition: 0.25s;
    }

    #startButton:hover {
        background: rgba(255,255,255,0.1);
        transform: scale(1.05);
    }

    #fadeLayer {
        position: fixed;
        top: 0; left: 0;
        width: 100vw;
        height: 100vh;
        background: black;
        z-index: 8;
        opacity: 0;
        pointer-events: none;
        transition: opacity 1s ease;
    }

    #linkHitbox {
        position: fixed;
        width: 10vw;
        height: 10vw;
        max-width: 150px;
        max-height: 150px;
        left: 18vw;
        top: 40vh;
        z-index: 5;
        background: rgba(255, 0, 0, 0);
    }

    /* ------------------------------ */
    /* OCARINA UI */
    /* ------------------------------ */

    .ocarina-container {
        position: fixed;
        right: 20px;
        bottom: 20px;
        display: flex;
        gap: 12px;
        z-index: 10;
    }

    .ocarina-btn {
        width: 65px;
        height: 65px;
        cursor: pointer;
        transition: transform 0.15s ease;
        -webkit-tap-highlight-color: transparent !important;
        outline: none !important;
        user-select: none;
    }

    .ocarina-btn:active {
        transform: scale(0.88);
    }

    /* Up key lifted slightly to form triangle */
    #btnUp {
        margin-bottom: 20px;
    }

</style>
</head>

<body>

<video id="bgVideo" src="video-vertical.mp4" autoplay loop muted playsinline></video>

<video id="secretVideo" src="easter-eggs/creepy-link-scene.mp4" playsinline></video>

<audio id="bgMusic"></audio>
<audio id="pressSound" src="press-start.mp3"></audio>

<!-- Ocarina buttons (start hidden, appear only after Press Start when eligible) -->
<div id="ocarina" class="ocarina-container" style="display:none;">
    <img id="btnLeft"  class="ocarina-btn" src="ocarina/left-ar-oc.png" alt="Left">
    <img id="btnUp"    class="ocarina-btn" src="ocarina/up-ar-oc.png" alt="Up">
    <img id="btnRight" class="ocarina-btn" src="ocarina/right-ar-oc.png" alt="Right">
</div>

<div id="overlay">
    <div id="quote"></div>
    <div id="startButton">PRESS START</div>
</div>

<div id="fadeLayer"></div>
<div id="linkHitbox"></div>

<script>
/* Quotes */
const quotes = [
    "“A sword wields no strength unless the hand that holds it has courage.”",
    "“Shadow and light are two sides of the same coin.”",
    "“Hero of Twilight, lend your power to this sacred blade.”",
    "“The twilight there holds a serene beauty… you have seen it for yourself.”",
    "“I... I wanted to see you again, Link.”",
    "“Courage need not be remembered, for it is never forgotten.”",
    "“Light and shadow can't mix as one, but they can coexist.”"
];

document.getElementById("quote").innerText =
    quotes[Math.floor(Math.random() * quotes.length)];

const bgMusic = document.getElementById("bgMusic");
const pressSound = document.getElementById("pressSound");
const overlay = document.getElementById("overlay");
const fadeLayer = document.getElementById("fadeLayer");
const bgVideo = document.getElementById("bgVideo");
const secretVideo = document.getElementById("secretVideo");

/* =====================================================
   ORIENTATION VIDEO SWITCH (unchanged behavior)
===================================================== */
function updateVideoByOrientation() {
    const isLandscape = window.matchMedia("(orientation: landscape)").matches;

    const newSrc = isLandscape
        ? (window.lullabyMode ? "ocarina/zelda-lullaby-horizontal.mp4" : "video-horizontal.mp4")
        : (window.lullabyMode ? "ocarina/zelda-lullaby-vertical.mp4"   : "video-vertical.mp4");

    if (bgVideo.src.includes(newSrc)) return;

    const currentTime = bgVideo.currentTime;
    const wasPaused = bgVideo.paused;

    bgVideo.src = newSrc;

    bgVideo.onloadedmetadata = () => {
        // try to keep current time where possible
        try { bgVideo.currentTime = Math.min(currentTime, bgVideo.duration || 0); } catch(e) {}
        if (!wasPaused) bgVideo.play();
    };
}

window.lullabyMode = false;
updateVideoByOrientation();
window.addEventListener("orientationchange", updateVideoByOrientation);
window.addEventListener("resize", updateVideoByOrientation);

/* =====================================================
       RANDOM MUSIC SYSTEM (unchanged)
===================================================== */
const musicList = [];
for (let i = 1; i <= 10; i++) {
    musicList.push(`music/music${i}.mp3`);
}

let lastTrack = -1;

function getRandomTrack() {
    let i;
    do i = Math.floor(Math.random() * musicList.length);
    while (i === lastTrack);
    lastTrack = i;
    return musicList[i];
}

function playRandomMusic() {
    bgMusic.src = getRandomTrack();
    bgMusic.play();
}
bgMusic.onended = playRandomMusic;

/* =====================================================
                     TIME FILTER
===================================================== */
function applyTimeFilter() {
    const hour = new Date().getHours();
    bgVideo.classList.remove('morningFilter','afternoonFilter','nightFilter');

    if (hour >= 6 && hour < 12)      bgVideo.classList.add('morningFilter');
    else if (hour >= 12 && hour <18) bgVideo.classList.add('afternoonFilter');
    else                              bgVideo.classList.add('nightFilter');
}
applyTimeFilter();

/* =====================================================
                  START BUTTON
===================================================== */
let ocarinaShouldAppear = false;

document.getElementById("startButton").onclick = () => {
    pressSound.play();
    overlay.style.opacity = "0";
    overlay.style.pointerEvents = "none";
    overlay.style.transition = "opacity 1.5s ease";

    bgMusic.volume = 0;
    playRandomMusic();

    let vol = 0;
    const fadeInterval = setInterval(() => {
        if (vol < 1) {
            vol += 0.02;
            bgMusic.volume = vol;
        } else clearInterval(fadeInterval);
    }, 80);

    if (ocarinaShouldAppear) {
        document.getElementById("ocarina").style.display = "flex";
    }
};

/* =====================================================
                     SECRET CUTSCENE
===================================================== */
let clickCount = 0;
let lastClickTime = 0;

document.getElementById("linkHitbox").addEventListener("click", () => {
    const now = Date.now();

    if (now - lastClickTime < 400) clickCount++;
    else clickCount = 1;

    lastClickTime = now;

    if (clickCount >= 10) {
        triggerSecretCutscene();
        clickCount = 0;
    }
});

function triggerSecretCutscene() {
    fadeLayer.style.opacity = "1";

    setTimeout(() => {
        bgMusic.pause();
        bgVideo.pause();

        secretVideo.style.display = "block";
        secretVideo.currentTime = 0;
        secretVideo.play();

        secretVideo.onended = () => {
            fadeLayer.style.opacity = "1";

            setTimeout(() => {
                secretVideo.style.display = "none";
                bgVideo.play();
                playRandomMusic();
                fadeLayer.style.opacity = "0";
            }, 800);
        };

        fadeLayer.style.opacity = "0";
    }, 800);
}

/* =====================================================
                     OCARINA EASTER EGG
===================================================== */

/* VISITS LOGIC */
let visits = Number(localStorage.getItem("visits") || 0) + 1;
localStorage.setItem("visits", visits);

/* The ocarina no longer shows before Start; only mark if should appear */
if (visits === 4) ocarinaShouldAppear = true;
else if (visits > 4 && Math.random() < 0.30) ocarinaShouldAppear = true;

/* BUTTON SEQUENCE */
const seq = [];
const correctSeq = ["L","U","R","L","U","R"];

const sounds = {
    L: new Audio("ocarina/left-oc.mp3"),
    U: new Audio("ocarina/up-oc.mp3"),
    R: new Audio("ocarina/right-oc.mp3"),
};

function playNote(note) {
    seq.push(note);
    sounds[note].currentTime = 0;
    sounds[note].play();

    if (seq.length > correctSeq.length) seq.shift();

    if (seq.join("") === correctSeq.join("")) {
        // clear sequence to avoid double-trigger
        seq.length = 0;
        triggerLullabySequence();
    }
}

document.getElementById("btnLeft").onclick  = () => playNote("L");
document.getElementById("btnUp").onclick    = () => playNote("U");
document.getElementById("btnRight").onclick = () => playNote("R");

/* =====================================================
            TRIGGER LULLABY EASTER EGG (NEW FLOW)
===================================================== */

function triggerLullabySequence() {
    // play immediate "correct" sound
    const correctSound = new Audio("ocarina/song-correct.mp3");
    correctSound.currentTime = 0;
    correctSound.play();

    // visual: fade out ocarina UI
    const ocarinaDiv = document.getElementById("ocarina");
    ocarinaDiv.style.transition = "opacity 0.6s ease";
    ocarinaDiv.style.opacity = "0";

    // after UI fade, darken screen and play short lullaby (oot-lullaby.mp3)
    setTimeout(() => {
        // darken screen
        fadeLayer.style.transition = "opacity 0.6s ease";
        fadeLayer.style.opacity = "1";

        // pause current background music and video
        try { bgMusic.pause(); } catch(e) {}
        try { bgVideo.pause(); } catch(e) {}

        // play oot-lullaby (small music before switching video)
        const oot = new Audio("ocarina/oot-lullaby.mp3");
        oot.currentTime = 0;
        oot.play();

        oot.onended = () => {
            // hide ocarina permanently (after sequence)
            ocarinaDiv.style.display = "none";

            // switch to lullaby video mode
            window.lullabyMode = true;
            updateVideoByOrientation();

            // ensure bgVideo starts from beginning and loops as before
            try { bgVideo.currentTime = 0; } catch(e) {}
            try { bgVideo.play(); } catch(e) {}

            // start background music exactly with music3.mp3
            bgMusic.src = "music/music3.mp3";
            bgMusic.currentTime = 0;
            bgMusic.play();

            // when music3 ends, resume random playback as before
            bgMusic.onended = () => {
                // restore onended handler to default random behavior
                bgMusic.onended = playRandomMusic;
                playRandomMusic();
            };

            // fade back to normal after short delay so video is visible
            setTimeout(() => {
                fadeLayer.style.opacity = "0";
            }, 350);
        };
    }, 650);
}

</script>

</body>
</html>
