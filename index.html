<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
  <title>Zelda AR Poster - Corrigido</title>

  <!-- A-Frame + MindAR -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>

  <style>
    html,body { height:100%; margin:0; background:#000; font-family:Inter,Arial,Helvetica,sans-serif; }
    a-scene{ width:100%; height:100vh; display:block; }
    #startButton{
      position:fixed; inset:0; z-index:9999;
      display:flex; align-items:center; justify-content:center;
      background: rgba(0,0,0,0.85); color:#fff; font-size:20px;
      -webkit-user-select:none; user-select:none; cursor:pointer;
    }
    #msg {
      position: fixed; left: 12px; bottom: 12px; color:#ddd; font-size:12px; z-index:10000;
    }
  </style>
</head>
<body>

<div id="startButton">TOQUE PARA INICIAR (permita a câmera)</div>
<div id="msg">Aponte a câmera para o pôster</div>

<a-scene
  mindar-image="imageTargetSrc: target.mind; autoStart: false;"
  embedded
  vr-mode-ui="enabled: false"
  color-space="sRGB">

  <a-assets>
    <!-- video e audio (nomes fáceis para substituir) -->
    <video id="videoAsset" src="video.mp4" playsinline webkit-playsinline loop crossorigin="anonymous"></video>
    <audio id="audioAsset" src="music.mp3" preload="auto" loop></audio>
  </a-assets>

  <!-- Entidade que será usada pela câmera AR -->
  <!-- O motor do MindAR irá arrancar a câmera quando chamarmos start() -->
  <a-entity camera></a-entity>

  <!-- Container do target (vídeo sobreposto ao targetIndex 0) -->
  <a-entity id="targetEntity" mindar-image-target="targetIndex: 0" visible="false">
    <!-- aqui usamos a-video como filho do entity -->
    <a-video id="planeVideo"
             src="#videoAsset"
             width="1.0"
             height="0.56"
             position="0 0 0"
             rotation="0 0 0"
             material="shader: flat; opacity: 1;">
    </a-video>
  </a-entity>

</a-scene>

<script>
(async () => {
  const startButton = document.getElementById('startButton');
  const msg = document.getElementById('msg');
  const scene = document.querySelector('a-scene');
  const videoEl = document.getElementById('videoAsset');
  const audioEl = document.getElementById('audioAsset');
  const targetEntity = document.getElementById('targetEntity');

  // pega o sistema MindAR (A-Frame)
  function getMindarSystem() {
    return scene && scene.systems && scene.systems["mindar-image-system"];
  }

  // Função para iniciar MindAR (camera + tracking)
  async function startMindAR() {
    const mindar = getMindarSystem();
    if (!mindar) throw new Error("MindAR system não encontrado (verifique se script foi carregado).");
    try {
      // start() abre a câmera e começa o pipeline de tracking
      await mindar.start();
      console.log("MindAR: câmera iniciada.");
      msg.innerText = "Câmera ativada — aponte para o pôster";
    } catch (err) {
      console.error("Erro ao iniciar MindAR:", err);
      throw err;
    }
  }

  // Eventos do sistema: targetFound / targetLost são emitidos no document a-scene
  scene.addEventListener("targetFound", (e) => {
    console.log("targetFound", e);
    // torna visível a entidade (caso esteja invisível)
    targetEntity.setAttribute('visible', 'true');

    // tenta tocar mídias (já houve gesture pelo botão)
    const p1 = videoEl.play().catch(err => { console.warn("video.play erro:", err); });
    const p2 = audioEl.play().catch(err => { console.warn("audio.play erro:", err); });

    Promise.all([p1, p2]).then(() => {
      console.log("Mídias tocando.");
    });
  });

  scene.addEventListener("targetLost", (e) => {
    console.log("targetLost", e);
    targetEntity.setAttribute('visible', 'false');
    // pausar para economizar CPU / bateria
    try { videoEl.pause(); } catch(e) {}
    try { audioEl.pause(); } catch(e) {}
  });

  // Quando o usuário clica 'TOQUE PARA INICIAR'
  startButton.addEventListener('click', async () => {
    startButton.style.display = 'none';
    msg.innerText = "Solicitando permissão para câmera...";

    // tentativa de tocar áudio/vídeo imediatamente (garante permissões de autoplay após gesture)
    try {
      await audioEl.play().catch(()=>{}); // pode falhar, mas pedimos a permissão
      await videoEl.play().catch(()=>{});
      // pausamos de imediato — quando target for encontrado vamos tocar de novo
      videoEl.pause();
      audioEl.pause();
    } catch(e) {
      console.warn("Tentativa inicial play falhou:", e);
    }

    // inicia MindAR (abre câmera e tracking)
    try {
      await startMindAR();
    } catch(err) {
      alert("Não foi possível ativar a câmera. Verifique permissões e tente novamente.");
      startButton.style.display = 'flex';
      return;
    }

    // opcional: mostrar instrução curta
    msg.innerText = "Aponte a câmera para o pôster. Toque no pôster (se necessário).";
  });

  // limpar quando a página for descartada
  window.addEventListener('pagehide', async () => {
    const mindar = getMindarSystem();
    if (mindar) {
      try { await mindar.stop(); } catch(e){/*ignore*/ }
    }
  });

})();
</script>
</body>
</html>
