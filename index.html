<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.1.5/dist/mindar-image.prod.js"></script>

    <style>
      body, html {
        margin: 0;
        padding: 0;
        background: black;
      }
      #startButton {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.85);
        color: white;
        font-size: 22px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        cursor: pointer;
      }
      #msg {
        color: white;
        position: fixed;
        bottom: 10px;
        left: 10px;
        z-index: 9999;
      }
    </style>
  </head>

  <body>

    <div id="startButton">TOQUE PARA INICIAR</div>
    <div id="msg">Pronto para iniciar</div>

    <a-scene
      mindar-image="imageTargetSrc: target.mind; autoStart: false;"
      color-space="sRGB"
      renderer="colorManagement: true; physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      embedded
      device-orientation-permission-ui="enabled: false">

      <a-assets>
        <video id="videoAsset" src="video.mp4" preload="auto" loop playsinline></video>
        <audio id="audioAsset" src="music.mp3" preload="auto" loop></audio>
      </a-assets>

      <!-- câmera DO MINDAR → obrigatória -->
      <a-entity mindar-image-camera></a-entity>

      <!-- target -->
      <a-entity id="targetEntity" mindar-image-target="targetIndex: 0" visible="false">

        <a-video src="#videoAsset" width="1" height="0.56"></a-video>

      </a-entity>

    </a-scene>

    <script>
      const startButton = document.getElementById("startButton");
      const msg = document.getElementById("msg");

      const scene = document.querySelector("a-scene");
      const videoEl = document.querySelector("#videoAsset");
      const audioEl = document.querySelector("#audioAsset");
      const targetEntity = document.querySelector("#targetEntity");

      function mindar() {
        return scene.systems["mindar-image-system"];
      }

      scene.addEventListener("loaded", () => {
        msg.innerText = "Clique para ativar AR";
      });

      startButton.addEventListener("click", async () => {
        startButton.style.display = "none";
        msg.innerText = "Abrindo câmera...";

        try {
          await mindar().start(); // AQUI A PERMISSÃO É SOLICITADA
          msg.innerText = "Aponte para o pôster";
        } catch (err) {
          console.error("Erro ao abrir câmera:", err);
          alert("Não foi possível ativar a câmera.");
          startButton.style.display = "flex";
        }
      });

      scene.addEventListener("targetFound", () => {
        targetEntity.setAttribute("visible", true);
        videoEl.play();
        audioEl.play();
      });

      scene.addEventListener("targetLost", () => {
        targetEntity.setAttribute("visible", false);
        videoEl.pause();
        audioEl.pause();
      });
    </script>

  </body>
</html>
